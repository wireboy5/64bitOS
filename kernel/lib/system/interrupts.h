#pragma once
#include <stdint.h>
#include <string.h>
#include <io/serial.h>
#define ISR_PROTO(number) void isr_ ## number ()

// IDT entry
struct idt_entry {
    uint16_t base_lo;
    uint16_t selector;
    uint8_t always0;
    uint8_t flags;
    uint16_t base_mid;
    uint32_t base_hi;
    uint32_t reserved;
} __attribute__((packed));
typedef struct idt_entry idt_entry_t;

// IDT pointer
struct idt_pointer {
    uint16_t limit;
    uint64_t base;
} __attribute__((packed));
typedef struct idt_pointer idt_pointer_t;

// Registers that are passed to the ISRs
struct isr_regs {
    uint64_t ds; // Data Segment Descriptor
    uint64_t rdi, rsi, rbp, old_rsp, rbx, rdx, rcx, rax; // General Purpose Registers
    uint64_t r8, r9, r10, r11, r12, r13, r14, r15; // General Purpose Registers
    uint64_t int_no, err_code; // Interrupt Number and Error Code
    uint64_t rip, cs, eflags, rsp, ss;
};
typedef struct isr_regs isr_regs_t;


void init_idt();
void isr_handler(isr_regs_t *regs);

extern void register_interrupt_handlers(void* idt);
extern void load_idt(uint64_t idt_ptr);

// Isr prototypes 0 - 255
ISR_PROTO(0);
ISR_PROTO(1);
ISR_PROTO(2);
ISR_PROTO(3);
ISR_PROTO(4);
ISR_PROTO(5);
ISR_PROTO(6);
ISR_PROTO(7);
ISR_PROTO(8);
ISR_PROTO(9);
ISR_PROTO(10);
ISR_PROTO(11);
ISR_PROTO(12);
ISR_PROTO(13);
ISR_PROTO(14);
ISR_PROTO(15);
ISR_PROTO(16);
ISR_PROTO(17);
ISR_PROTO(18);
ISR_PROTO(19);
ISR_PROTO(20);
ISR_PROTO(21);
ISR_PROTO(22);
ISR_PROTO(23);
ISR_PROTO(24);
ISR_PROTO(25);
ISR_PROTO(26);
ISR_PROTO(27);
ISR_PROTO(28);
ISR_PROTO(29);
ISR_PROTO(30);
ISR_PROTO(31);
ISR_PROTO(32);
ISR_PROTO(33);
ISR_PROTO(34);
ISR_PROTO(35);
ISR_PROTO(36);
ISR_PROTO(37);
ISR_PROTO(38);
ISR_PROTO(39);
ISR_PROTO(40);
ISR_PROTO(41);
ISR_PROTO(42);
ISR_PROTO(43);
ISR_PROTO(44);
ISR_PROTO(45);
ISR_PROTO(46);
ISR_PROTO(47);
ISR_PROTO(48);
ISR_PROTO(49);
ISR_PROTO(50);
ISR_PROTO(51);
ISR_PROTO(52);
ISR_PROTO(53);
ISR_PROTO(54);
ISR_PROTO(55);
ISR_PROTO(56);
ISR_PROTO(57);
ISR_PROTO(58);
ISR_PROTO(59);
ISR_PROTO(60);
ISR_PROTO(61);
ISR_PROTO(62);
ISR_PROTO(63);
ISR_PROTO(64);
ISR_PROTO(65);
ISR_PROTO(66);
ISR_PROTO(67);
ISR_PROTO(68);
ISR_PROTO(69);
ISR_PROTO(70);
ISR_PROTO(71);
ISR_PROTO(72);
ISR_PROTO(73);
ISR_PROTO(74);
ISR_PROTO(75);
ISR_PROTO(76);
ISR_PROTO(77);
ISR_PROTO(78);
ISR_PROTO(79);
ISR_PROTO(80);
ISR_PROTO(81);
ISR_PROTO(82);
ISR_PROTO(83);
ISR_PROTO(84);
ISR_PROTO(85);
ISR_PROTO(86);
ISR_PROTO(87);
ISR_PROTO(88);
ISR_PROTO(89);
ISR_PROTO(90);
ISR_PROTO(91);
ISR_PROTO(92);
ISR_PROTO(93);
ISR_PROTO(94);
ISR_PROTO(95);
ISR_PROTO(96);
ISR_PROTO(97);
ISR_PROTO(98);
ISR_PROTO(99);
ISR_PROTO(100);
ISR_PROTO(101);
ISR_PROTO(102);
ISR_PROTO(103);
ISR_PROTO(104);
ISR_PROTO(105);
ISR_PROTO(106);
ISR_PROTO(107);
ISR_PROTO(108);
ISR_PROTO(109);
ISR_PROTO(110);
ISR_PROTO(111);
ISR_PROTO(112);
ISR_PROTO(113);
ISR_PROTO(114);
ISR_PROTO(115);
ISR_PROTO(116);
ISR_PROTO(117);
ISR_PROTO(118);
ISR_PROTO(119);
ISR_PROTO(120);
ISR_PROTO(121);
ISR_PROTO(122);
ISR_PROTO(123);
ISR_PROTO(124);
ISR_PROTO(125);
ISR_PROTO(126);
ISR_PROTO(127);
ISR_PROTO(128);
ISR_PROTO(129);
ISR_PROTO(130);
ISR_PROTO(131);
ISR_PROTO(132);
ISR_PROTO(133);
ISR_PROTO(134);
ISR_PROTO(135);
ISR_PROTO(136);
ISR_PROTO(137);
ISR_PROTO(138);
ISR_PROTO(139);
ISR_PROTO(140);
ISR_PROTO(141);
ISR_PROTO(142);
ISR_PROTO(143);
ISR_PROTO(144);
ISR_PROTO(145);
ISR_PROTO(146);
ISR_PROTO(147);
ISR_PROTO(148);
ISR_PROTO(149);
ISR_PROTO(150);
ISR_PROTO(151);
ISR_PROTO(152);
ISR_PROTO(153);
ISR_PROTO(154);
ISR_PROTO(155);
ISR_PROTO(156);
ISR_PROTO(157);
ISR_PROTO(158);
ISR_PROTO(159);
ISR_PROTO(160);
ISR_PROTO(161);
ISR_PROTO(162);
ISR_PROTO(163);
ISR_PROTO(164);
ISR_PROTO(165);
ISR_PROTO(166);
ISR_PROTO(167);
ISR_PROTO(168);
ISR_PROTO(169);
ISR_PROTO(170);
ISR_PROTO(171);
ISR_PROTO(172);
ISR_PROTO(173);
ISR_PROTO(174);
ISR_PROTO(175);
ISR_PROTO(176);
ISR_PROTO(177);
ISR_PROTO(178);
ISR_PROTO(179);
ISR_PROTO(180);
ISR_PROTO(181);
ISR_PROTO(182);
ISR_PROTO(183);
ISR_PROTO(184);
ISR_PROTO(185);
ISR_PROTO(186);
ISR_PROTO(187);
ISR_PROTO(188);
ISR_PROTO(189);
ISR_PROTO(190);
ISR_PROTO(191);
ISR_PROTO(192);
ISR_PROTO(193);
ISR_PROTO(194);
ISR_PROTO(195);
ISR_PROTO(196);
ISR_PROTO(197);
ISR_PROTO(198);
ISR_PROTO(199);
ISR_PROTO(200);
ISR_PROTO(201);
ISR_PROTO(202);
ISR_PROTO(203);
ISR_PROTO(204);
ISR_PROTO(205);
ISR_PROTO(206);
ISR_PROTO(207);
ISR_PROTO(208);
ISR_PROTO(209);
ISR_PROTO(210);
ISR_PROTO(211);
ISR_PROTO(212);
ISR_PROTO(213);
ISR_PROTO(214);
ISR_PROTO(215);
ISR_PROTO(216);
ISR_PROTO(217);
ISR_PROTO(218);
ISR_PROTO(219);
ISR_PROTO(220);
ISR_PROTO(221);
ISR_PROTO(222);
ISR_PROTO(223);
ISR_PROTO(224);
ISR_PROTO(225);
ISR_PROTO(226);
ISR_PROTO(227);
ISR_PROTO(228);
ISR_PROTO(229);
ISR_PROTO(230);
ISR_PROTO(231);
ISR_PROTO(232);
ISR_PROTO(233);
ISR_PROTO(234);
ISR_PROTO(235);
ISR_PROTO(236);
ISR_PROTO(237);
ISR_PROTO(238);
ISR_PROTO(239);
ISR_PROTO(240);
ISR_PROTO(241);
ISR_PROTO(242);
ISR_PROTO(243);
ISR_PROTO(244);
ISR_PROTO(245);
ISR_PROTO(246);
ISR_PROTO(247);
ISR_PROTO(248);
ISR_PROTO(249);
ISR_PROTO(250);
ISR_PROTO(251);
ISR_PROTO(252);
ISR_PROTO(253);
ISR_PROTO(254);
ISR_PROTO(255);
